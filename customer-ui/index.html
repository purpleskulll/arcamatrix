<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Arcamatrix AI Assistant</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a1a;--surface:#12122a;--surface2:#1a1a3a;--border:#2a2a4a;--primary:#667eea;--primary2:#764ba2;--text:#e0e0f0;--text2:#8888aa;--success:#22c55e;--warning:#f59e0b;--error:#ef4444;--sidebar-w:260px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);height:100vh;height:100dvh;overflow:hidden;-webkit-tap-highlight-color:transparent}
.app{display:flex;height:100vh;height:100dvh}

/* Login */
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;height:100dvh;width:100vw;background:linear-gradient(135deg,#667eea22,#764ba222);padding:20px}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:400px;text-align:center}
.login-box h1{font-size:28px;margin-bottom:8px;background:linear-gradient(135deg,var(--primary),var(--primary2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-box p{color:var(--text2);margin-bottom:24px;font-size:14px}
.login-box input{width:100%;padding:14px 18px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:16px;margin-bottom:16px;outline:none;-webkit-appearance:none}
.login-box input:focus{border-color:var(--primary)}
.login-box button{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:opacity .2s;min-height:48px}
.login-box button:hover{opacity:.9}
.login-error{color:var(--error);font-size:13px;margin-top:8px;min-height:20px}

/* Sidebar */
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;z-index:50}
.sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.sidebar-brand{font-size:20px;font-weight:700;background:linear-gradient(135deg,var(--primary),var(--primary2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.sidebar-close{display:none;background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer;padding:4px 8px;line-height:1}
.sidebar-customer{font-size:13px;color:var(--text2);margin-top:2px;padding:0 20px}
.sidebar-status{font-size:12px;margin-top:6px;display:flex;align-items:center;gap:6px;padding:0 20px}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.status-dot.online{background:var(--success)}
.status-dot.offline{background:var(--error)}

/* Sidebar nav */
.sidebar-nav{padding:12px}
.nav-btn{width:100%;padding:12px 14px;background:transparent;border:1px solid transparent;border-radius:8px;color:var(--text2);font-size:14px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .15s;text-align:left;margin-bottom:4px;min-height:44px}
.nav-btn:hover{background:var(--surface2);color:var(--text)}
.nav-btn.active{background:var(--surface2);color:var(--text);border-color:var(--border);font-weight:600}
.nav-btn svg{flex-shrink:0}

/* Sidebar skills summary */
.sidebar-section{padding:12px 20px 6px;font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px}
.sidebar-skills{flex:1;overflow-y:auto;padding-bottom:12px}
.mini-skill{padding:8px 20px;display:flex;align-items:center;gap:10px;font-size:13px;color:var(--text2)}
.mini-skill .dot{width:6px;height:6px;border-radius:50%;background:var(--success);flex-shrink:0}

.sidebar-footer{margin-top:auto;padding:12px 16px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px}
.settings-btn,.logout-btn{width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;cursor:pointer;transition:background .2s;display:flex;align-items:center;justify-content:center;gap:8px;min-height:44px}
.settings-btn:hover,.logout-btn:hover{background:var(--border)}
.logout-btn{color:var(--error);border-color:transparent;background:transparent}
.logout-btn:hover{background:rgba(239,68,68,.1)}

/* Mobile header */
.mobile-header{display:none;padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);align-items:center;justify-content:space-between;flex-shrink:0;z-index:40}
.mobile-header .sidebar-brand{font-size:18px}
.hamburger{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:4px;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}
.mobile-status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)}

/* Sidebar overlay for mobile */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:45}

/* Main content area */
.main{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden}

/* Chat view */
.chat-view{flex:1;display:flex;flex-direction:column;min-height:0}
.chat-header{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--surface);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.chat-title{font-size:16px;font-weight:600}
.chat-session{font-size:12px;color:var(--text2)}
.messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;-webkit-overflow-scrolling:touch}
.msg{display:flex;gap:10px;max-width:90%}
.msg.user{align-self:flex-end;flex-direction:row-reverse}
.msg-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.msg.assistant .msg-avatar{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
.msg.user .msg-avatar{background:var(--surface2);color:var(--text2)}
.msg-bubble{padding:12px 16px;border-radius:12px;line-height:1.6;font-size:14px;white-space:pre-wrap;word-break:break-word}
.msg.assistant .msg-bubble{background:var(--surface2);border:1px solid var(--border)}
.msg.user .msg-bubble{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff}
.msg-bubble code{background:rgba(255,255,255,.1);padding:2px 6px;border-radius:4px;font-size:13px}
.msg-bubble pre{background:rgba(0,0,0,.3);padding:12px;border-radius:8px;overflow-x:auto;margin:8px 0}
.msg-bubble pre code{background:none;padding:0}

/* Input */
.input-area{padding:12px 16px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0}
.input-row{display:flex;gap:10px}
.input-row textarea{flex:1;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:16px;font-family:inherit;resize:none;outline:none;min-height:44px;max-height:150px;-webkit-appearance:none}
.input-row textarea:focus{border-color:var(--primary)}
.send-btn{padding:12px 20px;background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:opacity .2s;white-space:nowrap;min-height:44px}
.send-btn:hover{opacity:.9}
.send-btn:disabled{opacity:.5;cursor:not-allowed}
.input-hint{font-size:11px;color:var(--text2);margin-top:4px}

/* Welcome screen */
.welcome{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;padding:24px}
.welcome h2{font-size:22px;margin-bottom:12px}
.welcome p{color:var(--text2);max-width:450px;line-height:1.6;font-size:14px}
.welcome .setup-hint{display:inline-block;margin-top:16px;padding:12px 20px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--primary);font-size:13px;cursor:pointer;min-height:44px;line-height:20px}
.welcome .setup-hint:hover{border-color:var(--primary)}

/* ===== Skills Full-Page View ===== */
.skills-view{flex:1;display:flex;flex-direction:column;min-height:0}
.skills-header{padding:20px 20px 0;flex-shrink:0}
.skills-header h2{font-size:22px;font-weight:700;margin-bottom:4px}
.skills-header p{color:var(--text2);font-size:14px;margin-bottom:16px}
.skills-grid-wrap{flex:1;overflow-y:auto;padding:0 20px 20px;-webkit-overflow-scrolling:touch}
.skills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}

/* Skill card in grid */
.skill-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;transition:all .2s;position:relative;-webkit-tap-highlight-color:transparent}
.skill-card:hover{border-color:var(--primary);box-shadow:0 8px 24px rgba(102,126,234,.15)}
.skill-card:active{transform:scale(.98)}
.skill-card-top{display:flex;align-items:flex-start;gap:12px;margin-bottom:10px}
.skill-emoji{font-size:28px;line-height:1}
.skill-card-info{flex:1;min-width:0}
.skill-card-name{font-size:15px;font-weight:700;margin-bottom:2px}
.skill-card-desc{font-size:12px;color:var(--text2);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.skill-card-badge{display:inline-block;font-size:11px;font-weight:600;padding:3px 10px;border-radius:10px;margin-top:6px}
.skill-card-badge.active{background:var(--success);color:#fff}
.skill-card-badge.needs-creds{background:var(--warning);color:#fff}
.skill-card-badge.not-installed{background:var(--text2);color:#fff}
.skill-card-badge.unavailable{background:var(--border);color:var(--text2)}

/* ===== Modals ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;padding:16px}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:520px;max-height:90vh;max-height:90dvh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal h2{font-size:20px;margin-bottom:4px;background:linear-gradient(135deg,var(--primary),var(--primary2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.modal .subtitle{color:var(--text2);font-size:13px;margin-bottom:20px}
.modal label{display:block;font-size:13px;font-weight:600;color:var(--text2);margin-bottom:6px;margin-top:16px}
.modal input,.modal select{width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;outline:none;-webkit-appearance:none;min-height:44px}
.modal input:focus,.modal select:focus{border-color:var(--primary)}
.modal-actions{display:flex;gap:10px;margin-top:24px;justify-content:flex-end;flex-wrap:wrap}
.modal-actions button{padding:12px 20px;border-radius:8px;font-size:14px;cursor:pointer;border:none;min-height:44px}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;font-weight:600}
.btn-primary:hover{opacity:.9}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border) !important}
.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--error);color:#fff;font-weight:600}
.btn-danger:hover{opacity:.85}
.modal-status{font-size:13px;margin-top:12px;min-height:20px}
.modal-status.success{color:var(--success)}
.modal-status.error{color:var(--error)}

/* Skill detail modal specifics */
.skill-detail-header{display:flex;align-items:center;gap:14px;margin-bottom:20px}
.skill-detail-emoji{font-size:42px;line-height:1}
.skill-detail-title{flex:1}
.skill-detail-title h2{font-size:20px;margin-bottom:2px}
.skill-detail-title .skill-detail-status{font-size:13px}
.skill-detail-section{margin-top:18px}
.skill-detail-section h3{font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.skill-detail-section p{font-size:13px;color:var(--text2);line-height:1.6}
.cred-input-group{margin-top:12px}
.cred-input-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;letter-spacing:.3px}
.cred-input-group input{width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;outline:none;font-family:monospace;min-height:44px}
.cred-input-group input:focus{border-color:var(--primary)}
.cred-input-group .hint{font-size:11px;color:var(--text2);margin-top:4px}
.help-links{margin-top:12px;display:flex;flex-wrap:wrap;gap:8px}
.help-link{display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--primary);font-size:12px;text-decoration:none;transition:border-color .2s;min-height:36px}
.help-link:hover{border-color:var(--primary)}
.info-box{padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;margin-top:12px}
.info-box p{font-size:13px;color:var(--text2);line-height:1.5}

/* API links in settings */
.api-links{margin-top:16px;padding:14px;background:var(--surface2);border-radius:8px;border:1px solid var(--border)}
.api-links h4{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
.api-links a{display:block;color:var(--primary);text-decoration:none;font-size:13px;padding:6px 0;min-height:32px;line-height:20px}
.api-links a:hover{text-decoration:underline}

/* ===== Mobile Responsive ===== */
@media(max-width:768px){
  .app{flex-direction:column}
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:280px;z-index:50;transform:translateX(-100%);transition:transform .25s ease;pointer-events:none}
  .sidebar.open{transform:translateX(0);pointer-events:auto}
  .sidebar-close{display:block}
  .sidebar-overlay.open{display:block}
  .mobile-header{display:flex}
  .chat-header{display:none}
  .main{width:100%;flex:1;min-height:0}
  .chat-view{flex:1;min-height:0}
  .messages{flex:1;padding:12px;min-height:0;overflow-y:auto}
  .msg{max-width:95%}
  .msg-avatar{width:28px;height:28px;font-size:11px}
  .msg-bubble{font-size:15px;padding:10px 14px}
  .input-area{padding:10px 12px;flex-shrink:0}
  .input-row{gap:8px}
  .input-row textarea{min-height:48px;font-size:16px;padding:12px 14px;border-radius:12px}
  .send-btn{padding:12px 16px;border-radius:12px;font-size:15px;min-height:48px}
  .input-hint{display:none}
  .welcome{padding:20px}
  .welcome h2{font-size:20px}
  .welcome p{font-size:13px}
  .skills-header{padding:16px 16px 0}
  .skills-header h2{font-size:20px}
  .skills-grid-wrap{padding:0 12px 12px}
  .skills-grid{grid-template-columns:1fr;gap:10px}
  .modal{margin:0;border-radius:12px;padding:20px;max-height:85vh;max-height:85dvh}
  .skill-detail-emoji{font-size:36px}
  .skill-detail-title h2{font-size:18px}
  .modal-actions{flex-direction:column}
  .modal-actions button{width:100%}
  .login-box{padding:28px 20px}
  .login-box h1{font-size:24px}
}

/* Safe area insets for notched phones */
@supports(padding-bottom:env(safe-area-inset-bottom)){
  .input-area{padding-bottom:calc(10px + env(safe-area-inset-bottom))}
  .sidebar-footer{padding-bottom:calc(12px + env(safe-area-inset-bottom))}
  .login-screen{padding-bottom:env(safe-area-inset-bottom)}
}

.hidden{display:none !important}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <div class="login-box">
    <h1>Arcamatrix</h1>
    <p>Enter your gateway token to connect to your AI assistant</p>
    <input type="password" id="tokenInput" placeholder="Gateway token" autocomplete="off">
    <button onclick="doLogin()">Connect</button>
    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" class="app hidden">

  <!-- Mobile Header -->
  <div class="mobile-header">
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">&#9776;</button>
    <div class="sidebar-brand">Arcamatrix</div>
    <div class="mobile-status">
      <span class="status-dot offline" id="mobileStatusDot"></span>
    </div>
  </div>

  <!-- Sidebar Overlay (mobile) -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">Arcamatrix</div>
      <button class="sidebar-close" onclick="closeSidebar()" aria-label="Close menu">&times;</button>
    </div>
    <div class="sidebar-customer" id="customerName"></div>
    <div class="sidebar-status">
      <span class="status-dot offline" id="statusDot"></span>
      <span id="statusText" style="font-size:12px;color:var(--text2)">Disconnected</span>
    </div>

    <!-- Navigation -->
    <div class="sidebar-nav">
      <button class="nav-btn active" id="navChat" onclick="showView('chat');closeSidebar()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Chat
      </button>
      <button class="nav-btn" id="navSkills" onclick="showView('skills');closeSidebar()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        Skills
      </button>
    </div>

    <!-- Active skills summary -->
    <div class="sidebar-section">Active Skills</div>
    <div class="sidebar-skills" id="sidebarSkills">
      <div class="mini-skill" style="color:var(--text2);font-style:italic;padding-left:20px">Loading...</div>
    </div>

    <div class="sidebar-footer">
      <button class="settings-btn" onclick="openSettings();closeSidebar()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
        Model &amp; API Key
      </button>
      <button class="logout-btn" onclick="doLogout()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
        Logout
      </button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main">

    <!-- Chat View -->
    <div class="chat-view" id="chatView">
      <div class="chat-header">
        <div>
          <div class="chat-title">AI Assistant</div>
          <div class="chat-session" id="sessionInfo">Ready to chat</div>
        </div>
        <button class="btn-secondary" style="padding:8px 14px;font-size:12px;border:1px solid var(--border);border-radius:6px;cursor:pointer;background:var(--surface2);color:var(--text);min-height:36px" onclick="newChat()">New Chat</button>
      </div>
      <div class="messages" id="messages">
        <div class="welcome" id="welcomeBlock">
          <div>
            <h2>Welcome!</h2>
            <p>Your personal AI assistant is ready. Configure your AI model and API key in Settings, then type a message below.</p>
            <div class="setup-hint" onclick="openSettings()">Open Settings to configure your AI provider</div>
          </div>
        </div>
      </div>
      <div class="input-area">
        <div class="input-row">
          <textarea id="chatInput" placeholder="Type your message..." rows="1" onkeydown="handleKey(event)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
        </div>
        <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
      </div>
    </div>

    <!-- Skills View (full page) -->
    <div class="skills-view hidden" id="skillsView">
      <div class="skills-header">
        <h2>Skill Catalog</h2>
        <p>Add capabilities to your AI assistant. Tap a skill to configure it.</p>
      </div>
      <div class="skills-grid-wrap">
        <div class="skills-grid" id="skillsGrid">
          <div style="padding:40px;color:var(--text2);text-align:center;grid-column:1/-1">Loading skills...</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal-overlay hidden" onclick="if(event.target===this)closeSettings()">
  <div class="modal">
    <h2>Model &amp; API Key Settings</h2>
    <p class="subtitle">Connect your own AI provider to power your assistant</p>
    <label>AI Provider</label>
    <select id="providerSelect" onchange="onProviderChange()">
      <option value="anthropic">Anthropic (Claude) - Recommended</option>
      <option value="openai">OpenAI (GPT)</option>
      <option value="google">Google (Gemini)</option>
      <option value="openrouter">OpenRouter (Multiple Models)</option>
      <option value="xai">xAI (Grok)</option>
    </select>
    <label>API Key</label>
    <input type="password" id="apiKeyInput" placeholder="Enter your API key">
    <label>Model</label>
    <input type="text" id="modelInput" placeholder="e.g. claude-sonnet-4-5-20250929">
    <div class="api-links">
      <h4>Get Your API Key</h4>
      <a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic (Claude) &rarr; console.anthropic.com</a>
      <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI (GPT) &rarr; platform.openai.com</a>
      <a href="https://aistudio.google.com/apikey" target="_blank">Google (Gemini) &rarr; aistudio.google.com</a>
      <a href="https://openrouter.ai/keys" target="_blank">OpenRouter &rarr; openrouter.ai</a>
      <a href="https://console.x.ai" target="_blank">xAI (Grok) &rarr; console.x.ai</a>
    </div>
    <div id="settingsStatus" class="modal-status"></div>
    <div class="modal-actions">
      <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
      <button class="btn-primary" onclick="saveSettings()">Save &amp; Apply</button>
    </div>
  </div>
</div>

<!-- Skill Detail Modal -->
<div id="skillDetailModal" class="modal-overlay hidden" onclick="if(event.target===this)closeSkillDetail()">
  <div class="modal">
    <div id="skillDetailContent"></div>
  </div>
</div>

<script>
let ws = null;
let token = '';
let msgIdCounter = 0;
let pendingCallbacks = {};
let isStreaming = false;
let appConfig = null;
let currentView = 'chat';
const SESSION_KEY = 'agent:main:web:dm:arcamatrix';

const PROVIDER_MODELS = {
  anthropic: 'claude-sonnet-4-5-20250929',
  openai: 'gpt-4o',
  google: 'gemini-2.5-flash',
  openrouter: 'anthropic/claude-sonnet-4-5-20250929',
  xai: 'grok-3'
};

const PROVIDER_PREFIXES = {
  anthropic: 'sk-ant-',
  openai: 'sk-',
  google: 'AI',
  openrouter: 'sk-or-',
  xai: 'xai-'
};

// Pretty metadata for known skills
const SKILL_META = {
  'weather':            { label: 'Weather',           emoji: '\u{1F324}\u{FE0F}', setup: 'No configuration needed. Works out of the box.' },
  'duckduckgo-search':  { label: 'Web Search',        emoji: '\u{1F50D}', setup: 'No configuration needed. Works out of the box.' },
  'github':             { label: 'GitHub',             emoji: '\u{1F419}', setup: 'GitHub CLI is pre-configured. No additional setup required.' },
  'coding-agent':       { label: 'Coding Agent',       emoji: '\u{1F9E9}', setup: 'No configuration needed. Uses the configured AI model.' },
  'gemini':             { label: 'Gemini CLI',         emoji: '\u{264A}',  setup: 'No configuration needed if Gemini is available.' },
  'notion':             { label: 'Notion',             emoji: '\u{1F4DD}', setup: 'Create an internal integration in Notion to get your API key, then share the pages you want accessible.', envLabels: { 'NOTION_API_KEY': 'Integration Token' }, envHints: { 'NOTION_API_KEY': 'Starts with ntn_ or secret_' }, links: [{ label: 'Create Notion Integration', url: 'https://www.notion.so/my-integrations' }] },
  'trello':             { label: 'Trello',             emoji: '\u{1F4CB}', setup: 'You need a Trello API Key and Token from the Trello Power-Up Admin page.', envLabels: { 'TRELLO_API_KEY': 'API Key', 'TRELLO_TOKEN': 'Token' }, links: [{ label: 'Get Trello API Keys', url: 'https://trello.com/power-ups/admin' }] },
  'slack':              { label: 'Slack',              emoji: '\u{1F4AC}', setup: 'Requires Slack app configuration. Contact support for setup assistance.' },
  'himalaya':           { label: 'Email (IMAP)',       emoji: '\u{1F4E7}', setup: 'Requires himalaya CLI configured with your email server details.' },
  'summarize':          { label: 'Summarize',          emoji: '\u{1F9FE}', setup: 'Requires the summarize CLI tool to be installed.' },
  'tmux':               { label: 'Terminal Sessions',  emoji: '\u{1F5A5}\u{FE0F}', setup: 'No configuration needed. Uses tmux.' },
  'healthcheck':        { label: 'Health Check',       emoji: '\u{1F6E1}\u{FE0F}', setup: 'System security and risk-tolerance configuration.' },
  'skill-creator':      { label: 'Skill Creator',      emoji: '\u{1F6E0}\u{FE0F}', setup: 'Create or update custom AgentSkills.' },
  'spotify-player':     { label: 'Spotify',            emoji: '\u{1F3B5}', setup: 'Requires Spotify player CLI (spogo) to be configured.' },
  'openai-image-gen':   { label: 'Image Generation',   emoji: '\u{1F3A8}', setup: 'Requires an OpenAI API key for DALL-E image generation.', envLabels: { 'OPENAI_API_KEY': 'OpenAI API Key' }, links: [{ label: 'Get OpenAI Key', url: 'https://platform.openai.com/api-keys' }] },
  'openai-whisper':     { label: 'Speech-to-Text (Local)', emoji: '\u{1F399}\u{FE0F}', setup: 'Requires the Whisper CLI installed locally.' },
  'openai-whisper-api': { label: 'Speech-to-Text (API)', emoji: '\u{1F399}\u{FE0F}', setup: 'Requires an OpenAI API key.', envLabels: { 'OPENAI_API_KEY': 'OpenAI API Key' }, links: [{ label: 'Get OpenAI Key', url: 'https://platform.openai.com/api-keys' }] },
  'nano-banana-pro':    { label: 'AI Image Edit',      emoji: '\u{1F5BC}\u{FE0F}', setup: 'Requires a Gemini API key.', envLabels: { 'GEMINI_API_KEY': 'Gemini API Key' }, links: [{ label: 'Get Gemini Key', url: 'https://aistudio.google.com/apikey' }] },
  'nano-pdf':           { label: 'PDF Editor',         emoji: '\u{1F4C4}', setup: 'Requires the nano-pdf CLI.' },
  'obsidian':           { label: 'Obsidian Notes',     emoji: '\u{1F4D3}', setup: 'Requires Obsidian CLI installed and a vault configured.' },
  'gog':                { label: 'Google Workspace',   emoji: '\u{1F4E8}', setup: 'Google Workspace CLI for Gmail, Calendar, Drive, Contacts.' },
  'voice-call':         { label: 'Voice Call',          emoji: '\u{1F4DE}', setup: 'Start voice calls via the OpenClaw voice-call plugin.' },
  'wacli':              { label: 'WhatsApp',           emoji: '\u{1F4F1}', setup: 'Send and search WhatsApp messages via wacli.' },
  'imsg':               { label: 'iMessage',           emoji: '\u{1F4AC}', setup: 'iMessage/SMS CLI for listing chats, history, and sending messages.' },
  'bluebubbles':        { label: 'BlueBubbles (iMessage)', emoji: '\u{1F535}', setup: 'Requires BlueBubbles server for iMessage.' },
  '1password':          { label: '1Password',          emoji: '\u{1F510}', setup: 'Requires 1Password CLI (op) installed.' },
  'video-frames':       { label: 'Video Frames',       emoji: '\u{1F3AC}', setup: 'Extract frames from videos. Requires ffmpeg.' },
  'session-logs':       { label: 'Session Logs',       emoji: '\u{1F4DC}', setup: 'Search and analyze your session logs. Requires ripgrep (rg).' },
  'sag':                { label: 'Text-to-Speech',     emoji: '\u{1F50A}', setup: 'ElevenLabs text-to-speech. Requires API key.', envLabels: { 'ELEVENLABS_API_KEY': 'ElevenLabs API Key' }, links: [{ label: 'Get ElevenLabs Key', url: 'https://elevenlabs.io' }] },
  'sonoscli':           { label: 'Sonos',              emoji: '\u{1F509}', setup: 'Control Sonos speakers. Requires sonos CLI.' },
  'openhue':            { label: 'Philips Hue',        emoji: '\u{1F4A1}', setup: 'Control Philips Hue lights. Requires openhue CLI.' },
  'apple-notes':        { label: 'Apple Notes',        emoji: '\u{1F34E}', setup: 'macOS only. Requires memo CLI.' },
  'apple-reminders':    { label: 'Apple Reminders',    emoji: '\u{2705}',  setup: 'macOS only. Requires remindctl CLI.' },
  'bear-notes':         { label: 'Bear Notes',         emoji: '\u{1F43B}', setup: 'Requires grizzly CLI for Bear notes.' },
  'things-mac':         { label: 'Things 3',           emoji: '\u{2611}\u{FE0F}', setup: 'macOS only. Requires things CLI.' },
  'clawhub':            { label: 'ClawHub',            emoji: '\u{1F4E6}', setup: 'Install community skills from ClawHub.' },
  'oracle':             { label: 'Oracle CLI',         emoji: '\u{1F52E}', setup: 'Prompt + file bundling tool.' },
  'goplaces':           { label: 'Google Places',      emoji: '\u{1F4CD}', setup: 'Requires a Google Places API key.', envLabels: { 'GOOGLE_PLACES_API_KEY': 'Google Places API Key' }, links: [{ label: 'Get API Key', url: 'https://console.cloud.google.com' }] },
  'local-places':       { label: 'Local Places',       emoji: '\u{1F4CD}', setup: 'Requires Google Places API key and uv.', envLabels: { 'GOOGLE_PLACES_API_KEY': 'Google Places API Key' } },
  'camsnap':            { label: 'Camera Capture',     emoji: '\u{1F4F7}', setup: 'Capture frames from RTSP/ONVIF cameras.' },
  'peekaboo':           { label: 'Screen Capture',     emoji: '\u{1F440}', setup: 'macOS only. Capture and automate UI.' },
  'blogwatcher':        { label: 'Blog Watcher',       emoji: '\u{1F4F0}', setup: 'Monitor blogs and RSS feeds.' },
  'gifgrep':            { label: 'GIF Search',         emoji: '\u{1F609}', setup: 'Search GIF providers.' },
  'blucli':             { label: 'BluOS Audio',        emoji: '\u{1F3B6}', setup: 'Control BluOS speakers.' },
  'eightctl':           { label: 'Eight Sleep',        emoji: '\u{1F6CF}\u{FE0F}', setup: 'Control Eight Sleep pods.' },
  'ordercli':           { label: 'Food Orders',        emoji: '\u{1F355}', setup: 'Check past Foodora orders.' },
  'mcporter':           { label: 'MCP Tools',          emoji: '\u{1F527}', setup: 'Manage MCP server connections.' },
  'model-usage':        { label: 'Model Usage Stats',  emoji: '\u{1F4CA}', setup: 'Track AI model usage costs.' },
  'songsee':            { label: 'Audio Visualizer',   emoji: '\u{1F3BC}', setup: 'Generate spectrograms from audio files.' },
  'sherpa-onnx-tts':    { label: 'Offline TTS',        emoji: '\u{1F50A}', setup: 'Local text-to-speech (no cloud).', envLabels: { 'SHERPA_ONNX_RUNTIME_DIR': 'Runtime Directory', 'SHERPA_ONNX_MODEL_DIR': 'Model Directory' } },
};

let allSkillsData = [];
let configHash = '';

// ===== Mobile Sidebar =====
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// ===== View switching =====
function showView(view) {
  currentView = view;
  document.getElementById('chatView').classList.toggle('hidden', view !== 'chat');
  document.getElementById('skillsView').classList.toggle('hidden', view !== 'skills');
  document.getElementById('navChat').classList.toggle('active', view === 'chat');
  document.getElementById('navSkills').classList.toggle('active', view === 'skills');
  if (view === 'skills') loadSkillsGrid();
  if (view === 'chat') document.getElementById('chatInput').focus();
}

// ===== Config =====
async function loadConfig() {
  try {
    const res = await fetch('/config.json');
    if (res.ok) appConfig = await res.json();
  } catch (e) {}
}

// ===== Connection =====
function nextId() { return 'msg-' + (++msgIdCounter); }

function doLogin() {
  token = document.getElementById('tokenInput').value.trim();
  if (!token) { document.getElementById('loginError').textContent = 'Please enter a token'; return; }
  document.getElementById('loginError').textContent = 'Connecting...';
  connect();
}

function doLogout() {
  sessionStorage.removeItem('arcamatrix_token');
  if (ws) { ws.onclose = null; ws.close(); ws = null; }
  token = '';
  document.getElementById('mainApp').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('tokenInput').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('tokenInput').focus();
  closeSidebar();
}

function connect() {
  let wsUrl;
  if (appConfig && appConfig.gatewayUrl) {
    const gw = appConfig.gatewayUrl.replace(/\/$/, '');
    wsUrl = gw.replace(/^https:/, 'wss:').replace(/^http:/, 'ws:') + '/';
  } else {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    wsUrl = `${proto}//${location.host}/`;
  }
  ws = new WebSocket(wsUrl);
  ws.onopen = () => {};
  ws.onmessage = (ev) => {
    let data;
    try { data = JSON.parse(ev.data); } catch { return; }

    if (data.type === 'event' && data.event === 'connect.challenge') {
      ws.send(JSON.stringify({
        type: 'req', id: nextId(), method: 'connect',
        params: {
          minProtocol: 3, maxProtocol: 3,
          client: { id: 'openclaw-control-ui', version: '1.0.0', platform: 'web', mode: 'webchat' },
          role: 'operator',
          scopes: ['operator.admin', 'operator.approvals', 'operator.pairing'],
          caps: [], commands: [], permissions: {},
          auth: { token },
          locale: navigator.language || 'en-US',
          userAgent: 'arcamatrix-web/1.0'
        }
      }));
      return;
    }

    if (data.type === 'res') {
      if (data.payload?.type === 'hello-ok') {
        // Save token to sessionStorage (persists on reload, cleared on tab close)
        sessionStorage.setItem('arcamatrix_token', token);
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        setConnected(true);
        loadSidebarSkills();
        return;
      }
      if (data.ok === false && data.error) {
        document.getElementById('loginError').textContent = data.error.message || 'Connection failed';
        sessionStorage.removeItem('arcamatrix_token');
        return;
      }
      if (pendingCallbacks[data.id]) {
        pendingCallbacks[data.id](data);
        delete pendingCallbacks[data.id];
      }
      return;
    }

    if (data.type === 'event' && data.event === 'chat') {
      const p = data.payload;
      if (p.state === 'delta' && p.message?.content?.[0]?.text) {
        updateStreamingMessage(p.message.content[0].text);
      } else if (p.state === 'final') {
        finalizeStreamingMessage(p.message?.content?.[0]?.text);
      } else if (p.state === 'error') {
        finalizeStreamingMessage(p.errorMessage || 'An error occurred. Please check your API key in Settings.', true);
      }
    }
  };

  ws.onclose = () => {
    setConnected(false);
    setTimeout(() => { if (token) connect(); }, 3000);
  };

  ws.onerror = () => {
    document.getElementById('loginError').textContent = 'Connection failed. Check your token.';
  };
}

function setConnected(online) {
  const cls = online ? 'status-dot online' : 'status-dot offline';
  const txt = online ? 'Connected' : 'Disconnected';
  const clr = online ? 'var(--success)' : 'var(--text2)';
  document.getElementById('statusDot').className = cls;
  document.getElementById('statusText').textContent = txt;
  document.getElementById('statusText').style.color = clr;
  document.getElementById('mobileStatusDot').className = cls;
}

function rpcCall(method, params, timeoutMs) {
  const timeout = timeoutMs || (method === 'skills.install' ? 120000 : 15000);
  return new Promise((resolve) => {
    const id = nextId();
    pendingCallbacks[id] = resolve;
    ws.send(JSON.stringify({ type: 'req', id, method, params }));
    setTimeout(() => { if (pendingCallbacks[id]) { delete pendingCallbacks[id]; resolve({ ok: false, error: { message: 'Request timed out' } }); } }, timeout);
  });
}

// ===== Chat =====
function addMessage(role, text) {
  const w = document.getElementById('welcomeBlock');
  if (w) w.remove();
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.innerHTML = `<div class="msg-avatar">${role === 'user' ? 'You' : 'AI'}</div><div class="msg-bubble">${escapeHtml(text)}</div>`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return div;
}

let streamDiv = null;
function updateStreamingMessage(text) {
  if (!streamDiv) {
    const w = document.getElementById('welcomeBlock');
    if (w) w.remove();
    streamDiv = document.createElement('div');
    streamDiv.className = 'msg assistant';
    streamDiv.innerHTML = '<div class="msg-avatar">AI</div><div class="msg-bubble"></div>';
    document.getElementById('messages').appendChild(streamDiv);
  }
  streamDiv.querySelector('.msg-bubble').textContent = text;
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

function finalizeStreamingMessage(text, isError) {
  if (text && streamDiv) {
    const bubble = streamDiv.querySelector('.msg-bubble');
    bubble.textContent = text;
    if (isError) bubble.style.color = 'var(--error)';
  } else if (text) {
    addMessage('assistant', text);
  }
  streamDiv = null;
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('chatInput').focus();
}

function escapeHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || isStreaming) return;
  input.value = '';
  input.style.height = 'auto';
  addMessage('user', text);
  isStreaming = true;
  document.getElementById('sendBtn').disabled = true;
  ws.send(JSON.stringify({
    type: 'req', id: nextId(), method: 'chat.send',
    params: { message: text, sessionKey: SESSION_KEY, idempotencyKey: nextId() }
  }));
}

function newChat() {
  document.getElementById('messages').innerHTML = `
    <div class="welcome" id="welcomeBlock">
      <div>
        <h2>New Conversation</h2>
        <p>Start a fresh conversation with your AI assistant.</p>
      </div>
    </div>`;
  streamDiv = null;
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  const ta = e.target;
  setTimeout(() => { ta.style.height = 'auto'; ta.style.height = Math.min(ta.scrollHeight, 150) + 'px'; }, 0);
}

// ===== Skills Grid (Full Page) =====
function getSkillMeta(name) {
  const meta = SKILL_META[name];
  if (meta) return meta;
  const label = name.replace(/[-_]/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  return { label, emoji: '\u{1F4E6}', setup: '' };
}

async function loadSkillsGrid() {
  const grid = document.getElementById('skillsGrid');
  grid.innerHTML = '<div style="padding:40px;color:var(--text2);text-align:center;grid-column:1/-1">Loading skills...</div>';

  try {
    const skillsRes = await rpcCall('skills.status', {});
    allSkillsData = skillsRes.payload?.skills || [];

    const configRes = await rpcCall('config.get', {});
    configHash = configRes.payload?.hash || '';

    grid.innerHTML = '';

    const sorted = [...allSkillsData].sort((a, b) => {
      const score = (s) => {
        if (s.eligible) return 0;
        if ((s.missing?.env || []).length > 0 && (s.missing?.bins || []).length === 0) return 1;
        return 2;
      };
      return score(a) - score(b) || a.name.localeCompare(b.name);
    });

    sorted.forEach(gwSkill => {
      const meta = getSkillMeta(gwSkill.name);
      const eligible = gwSkill.eligible || false;
      const missingEnv = gwSkill.missing?.env || [];
      const missingBins = gwSkill.missing?.bins || [];
      const desc = gwSkill.description || '';

      let badgeText, badgeClass;
      if (eligible) {
        badgeText = 'Active'; badgeClass = 'active';
      } else if (missingEnv.length > 0 && missingBins.length === 0) {
        badgeText = 'Needs Credentials'; badgeClass = 'needs-creds';
      } else if (missingBins.length > 0) {
        badgeText = 'Not Available'; badgeClass = 'unavailable';
      } else {
        badgeText = 'Inactive'; badgeClass = 'not-installed';
      }

      const card = document.createElement('div');
      card.className = 'skill-card';
      card.onclick = () => openSkillDetail(gwSkill.name);
      card.innerHTML = `
        <div class="skill-card-top">
          <div class="skill-emoji">${meta.emoji}</div>
          <div class="skill-card-info">
            <div class="skill-card-name">${meta.label}</div>
            <div class="skill-card-desc">${desc}</div>
          </div>
        </div>
        <span class="skill-card-badge ${badgeClass}">${badgeText}</span>`;
      grid.appendChild(card);
    });
  } catch (err) {
    grid.innerHTML = `<div style="padding:40px;color:var(--error);text-align:center;grid-column:1/-1">Failed to load skills: ${err.message || 'Connection error'}</div>`;
  }
}

// ===== Skill Detail Modal =====
function openSkillDetail(skillName) {
  const gwSkill = allSkillsData.find(s => s.name === skillName);
  if (!gwSkill) return;

  const meta = getSkillMeta(skillName);
  const eligible = gwSkill.eligible || false;
  const missingEnv = gwSkill.missing?.env || [];
  const missingBins = gwSkill.missing?.bins || [];
  const desc = gwSkill.description || '';
  const reqEnv = (gwSkill.requirements?.env || []).map(e => typeof e === 'string' ? e : (e.name || e));

  let statusHtml;
  if (eligible) {
    statusHtml = '<span style="color:var(--success)">Active</span>';
  } else if (missingEnv.length > 0 && missingBins.length === 0) {
    statusHtml = '<span style="color:var(--warning)">Needs Credentials</span>';
  } else if (missingBins.length > 0) {
    statusHtml = '<span style="color:var(--text2)">Not Available</span>';
  } else {
    statusHtml = '<span style="color:var(--text2)">Inactive</span>';
  }

  let html = `
    <div class="skill-detail-header">
      <div class="skill-detail-emoji">${meta.emoji}</div>
      <div class="skill-detail-title">
        <h2>${meta.label}</h2>
        <div class="skill-detail-status">${statusHtml}</div>
      </div>
    </div>

    <div class="skill-detail-section">
      <h3>About</h3>
      <p>${desc}</p>
    </div>`;

  if (meta.setup) {
    html += `<div class="skill-detail-section"><h3>Setup</h3><p>${meta.setup}</p></div>`;
  }

  const installOptions = gwSkill.install || [];
  if (missingBins.length > 0 && installOptions.length > 0) {
    html += `<div class="skill-detail-section"><h3>Installation Required</h3>`;
    html += `<p style="margin-bottom:12px">This skill needs <strong>${missingBins.join(', ')}</strong> to be installed.</p>`;
    installOptions.forEach(opt => {
      html += `<button class="btn-primary" style="margin-right:8px;margin-bottom:8px;padding:10px 18px;font-size:13px;min-height:44px" onclick="installSkillDep('${skillName}', '${opt.id}')">${opt.label}</button>`;
    });
    html += '</div>';
  } else if (missingBins.length > 0) {
    html += `<div class="info-box" style="margin-top:16px"><p>This skill requires <strong>${missingBins.join(', ')}</strong> which cannot be automatically installed. Contact support for assistance.</p></div>`;
  }

  const allEnvVars = reqEnv.length > 0 ? reqEnv : missingEnv;

  if (allEnvVars.length > 0) {
    html += `<div class="skill-detail-section"><h3>Credentials</h3>`;
    allEnvVars.forEach(envVar => {
      const label = meta.envLabels?.[envVar] || envVar;
      const hint = meta.envHints?.[envVar] || '';
      const isConfigured = missingEnv.indexOf(envVar) === -1;
      html += `
        <div class="cred-input-group">
          <label>${label}</label>
          <input type="password"
            id="detail-env-${envVar}"
            placeholder="${isConfigured ? '\u2022\u2022\u2022\u2022\u2022\u2022\u2022 (already configured)' : 'Enter your ' + label}"
            data-env="${envVar}">
          ${hint ? `<div class="hint">${hint}</div>` : ''}
        </div>`;
    });

    if (meta.links && meta.links.length > 0) {
      html += '<div class="help-links">';
      meta.links.forEach(link => {
        html += `<a href="${link.url}" target="_blank" class="help-link">${link.label} &rarr;</a>`;
      });
      html += '</div>';
    }
    html += '</div>';
  } else if (eligible) {
    html += `<div class="info-box" style="margin-top:16px"><p>This skill is active and ready to use. Just ask your assistant to use it in a conversation.</p></div>`;
  }

  html += `<div id="detailStatus" class="modal-status"></div>`;
  html += '<div class="modal-actions">';
  html += '<button class="btn-secondary" onclick="closeSkillDetail()">Close</button>';
  if (allEnvVars.length > 0) {
    const hasConfigured = allEnvVars.some(ev => missingEnv.indexOf(ev) === -1);
    if (hasConfigured) {
      html += `<button class="btn-danger" onclick="confirmClearCreds('${skillName}')">Clear Credentials</button>`;
    }
    html += `<button class="btn-primary" onclick="saveDetailCreds('${skillName}')">Save &amp; Activate</button>`;
  }
  html += '</div>';

  document.getElementById('skillDetailContent').innerHTML = html;
  document.getElementById('skillDetailModal').classList.remove('hidden');
}

function closeSkillDetail() {
  document.getElementById('skillDetailModal').classList.add('hidden');
  loadSkillsGrid();
  loadSidebarSkills();
}

async function saveDetailCreds(skillName) {
  const gwSkill = allSkillsData.find(s => s.name === skillName);
  if (!gwSkill) return;

  const reqEnv = (gwSkill.requirements?.env || []).map(e => typeof e === 'string' ? e : (e.name || e));
  const missingEnv = gwSkill.missing?.env || [];
  const allEnvVars = reqEnv.length > 0 ? reqEnv : missingEnv;

  const statusEl = document.getElementById('detailStatus');
  statusEl.textContent = 'Saving...';
  statusEl.className = 'modal-status';

  try {
    const configRes = await rpcCall('config.get', {});
    configHash = configRes.payload?.hash || '';
    const cfg = configRes.payload?.config || {};
    if (!cfg.env) cfg.env = {};

    let anySet = false;
    for (const envVar of allEnvVars) {
      const input = document.getElementById(`detail-env-${envVar}`);
      const val = input?.value?.trim();
      if (val) {
        cfg.env[envVar] = val;
        anySet = true;
      }
    }

    if (!anySet) {
      statusEl.textContent = 'Please enter at least one credential.';
      statusEl.className = 'modal-status error';
      return;
    }

    const res = await rpcCall('config.set', { raw: JSON.stringify(cfg), baseHash: configHash });

    if (res.ok) {
      statusEl.textContent = 'Credentials saved! The skill is now active.';
      statusEl.className = 'modal-status success';
      for (const envVar of allEnvVars) {
        const input = document.getElementById(`detail-env-${envVar}`);
        if (input) { input.value = ''; input.placeholder = '\u2022\u2022\u2022\u2022\u2022\u2022\u2022 (already configured)'; }
      }
      const skillsRes = await rpcCall('skills.status', {});
      allSkillsData = skillsRes.payload?.skills || [];
    } else {
      statusEl.textContent = res.error?.message || 'Failed to save credentials.';
      statusEl.className = 'modal-status error';
    }
  } catch (err) {
    statusEl.textContent = 'Error: ' + (err.message || 'Failed to save');
    statusEl.className = 'modal-status error';
  }
}

function confirmClearCreds(skillName) {
  const existing = document.getElementById('confirmOverlay');
  if (existing) existing.remove();
  const overlay = document.createElement('div');
  overlay.id = 'confirmOverlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:999;display:flex;align-items:center;justify-content:center;padding:20px';
  overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px;max-width:360px;width:100%;text-align:center';
  box.innerHTML = '<h3 style="margin:0 0 12px;color:var(--error)">Clear Credentials?</h3><p style="color:var(--text2);font-size:14px;margin:0 0 20px">This will remove all saved API keys for this skill. The skill will become inactive until you enter new credentials.</p><div style="display:flex;gap:10px;justify-content:center"><button class="btn-secondary" style="flex:1;min-height:44px" id="confirmCancel">Cancel</button><button class="btn-danger" style="flex:1;min-height:44px" id="confirmYes">Yes, Clear</button></div>';
  overlay.appendChild(box);
  document.body.appendChild(overlay);
  document.getElementById('confirmCancel').onclick = function() { overlay.remove(); };
  document.getElementById('confirmYes').onclick = function() { overlay.remove(); clearCreds(skillName); };
}

async function clearCreds(skillName) {
  const gwSkill = allSkillsData.find(s => s.name === skillName);
  if (!gwSkill) return;
  const reqEnv = (gwSkill.requirements?.env || []).map(e => typeof e === 'string' ? e : (e.name || e));
  const missingEnv = gwSkill.missing?.env || [];
  const allEnvVars = reqEnv.length > 0 ? reqEnv : missingEnv;
  const statusEl = document.getElementById('detailStatus');
  statusEl.textContent = 'Clearing credentials...';
  statusEl.className = 'modal-status';
  try {
    const configRes = await rpcCall('config.get', {});
    configHash = configRes.payload?.hash || '';
    const cfg = configRes.payload?.config || {};
    if (!cfg.env) cfg.env = {};
    for (const envVar of allEnvVars) { cfg.env[envVar] = ''; }
    const res = await rpcCall('config.set', { raw: JSON.stringify(cfg), baseHash: configHash });
    if (res.ok) {
      statusEl.textContent = 'Credentials cleared. The skill is now inactive.';
      statusEl.className = 'modal-status success';
      const skillsRes = await rpcCall('skills.status', {});
      allSkillsData = skillsRes.payload?.skills || [];
      setTimeout(() => openSkillDetail(skillName), 1000);
    } else {
      statusEl.textContent = res.error?.message || 'Failed to clear credentials.';
      statusEl.className = 'modal-status error';
    }
  } catch (err) {
    statusEl.textContent = 'Error: ' + (err.message || 'Failed to clear');
    statusEl.className = 'modal-status error';
  }
}

// ===== Install Skill Dependencies via RPC =====
async function installSkillDep(skillName, installId) {
  const statusEl = document.getElementById('detailStatus');
  statusEl.textContent = 'Installing... this may take a minute.';
  statusEl.className = 'modal-status';

  try {
    const res = await rpcCall('skills.install', { name: skillName, installId });
    if (res.ok && res.payload?.ok) {
      statusEl.textContent = 'Installed successfully! ' + (res.payload.message || '');
      statusEl.className = 'modal-status success';
      const skillsRes = await rpcCall('skills.status', {});
      allSkillsData = skillsRes.payload?.skills || [];
      setTimeout(() => openSkillDetail(skillName), 500);
    } else {
      const errMsg = res.payload?.stderr || res.payload?.message || res.error?.message || 'Installation failed';
      statusEl.textContent = 'Failed: ' + errMsg;
      statusEl.className = 'modal-status error';
    }
  } catch (err) {
    statusEl.textContent = 'Error: ' + (err.message || 'Installation failed');
    statusEl.className = 'modal-status error';
  }
}

// ===== Sidebar Skills =====
async function loadSidebarSkills() {
  try {
    const res = await rpcCall('skills.status', {});
    const skills = res.payload?.skills || [];
    allSkillsData = skills;
    const list = document.getElementById('sidebarSkills');
    list.innerHTML = '';

    const activeSkills = skills.filter(s => s.eligible);

    if (activeSkills.length > 0) {
      activeSkills.forEach(s => {
        const meta = getSkillMeta(s.name);
        const el = document.createElement('div');
        el.className = 'mini-skill';
        el.innerHTML = `<span class="dot"></span> ${meta.emoji} ${meta.label}`;
        list.appendChild(el);
      });
    } else {
      list.innerHTML = '<div class="mini-skill" style="font-style:italic">No active skills</div>';
    }
  } catch {
    document.getElementById('sidebarSkills').innerHTML = '<div class="mini-skill" style="font-style:italic">Unable to load</div>';
  }
}

// ===== Settings =====
function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); onProviderChange(); }
function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); document.getElementById('settingsStatus').textContent = ''; }

function onProviderChange() {
  const p = document.getElementById('providerSelect').value;
  document.getElementById('modelInput').value = PROVIDER_MODELS[p] || '';
  document.getElementById('apiKeyInput').placeholder = `Starts with ${PROVIDER_PREFIXES[p] || '...'}`;
}

async function saveSettings() {
  const provider = document.getElementById('providerSelect').value;
  const apiKey = document.getElementById('apiKeyInput').value.trim();
  const model = document.getElementById('modelInput').value.trim();
  const status = document.getElementById('settingsStatus');

  if (!apiKey) { status.textContent = 'Please enter an API key'; status.className = 'modal-status error'; return; }
  status.textContent = 'Saving...'; status.className = 'modal-status';

  try {
    const profileId = `${provider}:default`;
    const modelValue = model || PROVIDER_MODELS[provider];

    const configRes = await rpcCall('config.get', {});
    const hash = configRes.payload?.hash || '';
    const cfg = configRes.payload?.config || {};

    if (!cfg.auth) cfg.auth = {};
    if (!cfg.auth.profiles) cfg.auth.profiles = {};
    cfg.auth.profiles[profileId] = { provider, mode: 'api_key' };
    cfg.auth.activeProfile = profileId;

    if (!cfg.agents) cfg.agents = {};
    if (!cfg.agents.defaults) cfg.agents.defaults = {};
    if (!cfg.agents.defaults.model) cfg.agents.defaults.model = {};
    cfg.agents.defaults.model.primary = modelValue;

    const r1 = await rpcCall('config.set', { raw: JSON.stringify(cfg), baseHash: hash });
    const r2 = await rpcCall('models.auth.set', { profileId, token: apiKey });

    if (r1.ok) {
      status.textContent = r2.ok !== false
        ? 'Settings saved! You can now start chatting.'
        : 'Model configured. API key may need manual setup.';
      status.className = 'modal-status success';
    } else {
      status.textContent = r1.error?.message || 'Failed to save settings';
      status.className = 'modal-status error';
    }
  } catch (err) {
    status.textContent = 'Error: ' + (err.message || 'Failed to save');
    status.className = 'modal-status error';
  }
}

// ===== Init =====
loadConfig().then(() => {
  if (appConfig?.customerName) {
    document.getElementById('customerName').textContent = appConfig.customerName;
  }

  // Check sessionStorage for existing token (persists on page reload)
  const savedToken = sessionStorage.getItem('arcamatrix_token');
  if (savedToken) {
    token = savedToken;
    document.getElementById('loginError').textContent = 'Reconnecting...';
    connect();
  } else {
    document.getElementById('tokenInput').focus();
  }
});

document.getElementById('tokenInput').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

// Prevent iOS zoom on input focus
document.querySelectorAll('input, textarea, select').forEach(el => {
  el.addEventListener('focus', () => {
    document.querySelector('meta[name="viewport"]').setAttribute('content',
      'width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no');
  });
});
</script>
</body>
</html>
